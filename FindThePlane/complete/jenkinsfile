pipeline {
    agent any
    environment {
        dockerImage = ''
        registry = "http://192.168.160.48:5000"
      }
    stages {
        stage('Hello') {
            steps {
                echo 'Hello World'
            }
        }
         
        stage('Cloning repository') {
            steps {
                git(
                    branch: 'main',
                    url: 'https://github.com/DiogoFernandes77/ESP22'
                )
                sh "chmod +x -R ${env.WORKSPACE}"
            }
        }
        
        stage('testing') {
            steps {
                dir("FindThePlane/complete") {
                    sh 'mvn test'
                }
            }
        }
        
        stage('artifactory') {
            steps {
                dir("FindThePlane/complete") {
                    sh 'mvn -X -Dmaven.test.skip=true --settings ../settings.xml deploy'
                   
                }
            }
        }
        
      
        stage('build and deploy image') {
            steps{
                script{
                    dockerImage = docker.build("esp22_findtheplane","./FindThePlane/complete") 
                    docker.withRegistry(registry) {
                            dockerImage.push("$BUILD_NUMBER")
                            dockerImage.push('latest')
                    }  
                }
                
            }
        }
        
        
        
        
        
    }
        
    
}

